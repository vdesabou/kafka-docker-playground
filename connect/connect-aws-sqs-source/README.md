# AWS SQS Source connector



## Objective

Quickly test [SQS Connector](https://docs.confluent.io/current/connect/kafka-connect-sqs/index.html#quick-start) connector.



## AWS Setup

* Make sure you have an [AWS account](https://docs.aws.amazon.com/streams/latest/dev/before-you-begin.html#setting-up-sign-up-for-aws).
* Set up [AWS Credentials](https://docs.confluent.io/kafka-connectors/s3-sink/current/overview.html#aws-credentials)

You can either export environment variables `AWS_REGION`, `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` or set files `~/.aws/credentials` and `~/.aws/config`.

## How to run

Simply run:

```bash
$ playground run -f sqs<use tab key to activate fzf completion (see https://kafka-docker-playground.io/#/cli?id=%e2%9a%a1-setup-completion), otherwise use full path, or correct relative path>
```

Or using SASL_SSL authentication:

```bash
$ playground run -f sqs-sasl-ssl<use tab key to activate fzf completion (see https://kafka-docker-playground.io/#/cli?id=%e2%9a%a1-setup-completion), otherwise use full path, or correct relative path>
```

Or using 2 way SSL authentication:

```bash
$ playground run -f sqs-2way-ssl<use tab key to activate fzf completion (see https://kafka-docker-playground.io/#/cli?id=%e2%9a%a1-setup-completion), otherwise use full path, or correct relative path>
```

If you want to [assume](https://docs.confluent.io/kafka-connect-s3-sink/current/index.html#using-trusted-account-credentials) IAM roles:

```
$ playground run -f sqs-source-with-assuming-iam-role<use tab key to activate fzf completion (see https://kafka-docker-playground.io/#/cli?id=%e2%9a%a1-setup-completion), otherwise use full path, or correct relative path> (in that case `~/.aws/credentials-with-assuming-iam-role` file must be set)
```

## Details of what the script is doing

### With no security in place:

Create a FIFO queue `sqs-source-connector-demo`:

```bash
$ aws sqs create-queue --queue-name sqs-source-connector-demo
```

Send messages to queue (QUEUE_URL is generated by the script)

```bash
$ aws sqs send-message-batch --queue-url $QUEUE_URL --entries file://send-message-batch.json
```

```json
[
    {
        "Id": "FuelReport-0001-2015-09-16T140731Z",
        "MessageBody": "Fuel report for account 0001 on 2015-09-16 at 02:07:31 PM.",
        "DelaySeconds": 10,
        "MessageAttributes": {
            "SellerName": {
                "DataType": "String",
                "StringValue": "Example Store"
            },
            "City": {
                "DataType": "String",
                "StringValue": "Any City"
            },
            "Region": {
                "DataType": "String",
                "StringValue": "WA"
            },
            "PostalCode": {
                "DataType": "String",
                "StringValue": "99065"
            },
            "PricePerGallon": {
                "DataType": "Number",
                "StringValue": "1.99"
            }
        }
    },
    {
        "Id": "FuelReport-0002-2015-09-16T140930Z",
        "MessageBody": "Fuel report for account 0002 on 2015-09-16 at 02:09:30 PM.",
        "DelaySeconds": 10,
        "MessageAttributes": {
            "SellerName": {
                "DataType": "String",
                "StringValue": "Example Fuels"
            },
            "City": {
                "DataType": "String",
                "StringValue": "North Town"
            },
            "Region": {
                "DataType": "String",
                "StringValue": "WA"
            },
            "PostalCode": {
                "DataType": "String",
                "StringValue": "99123"
            },
            "PricePerGallon": {
                "DataType": "Number",
                "StringValue": "1.87"
            }
        }
    }
]
```


The connector is created with:

```bash
playground connector create-or-update --connector sqs-source --environment "${PLAYGROUND_ENVIRONMENT}" << EOF
{
        "connector.class": "io.confluent.connect.sqs.source.SqsSourceConnector",
               "tasks.max": "1",
               "kafka.topic": "test-sqs-source",
               "sqs.url": "$QUEUE_URL",
               "confluent.license": "",
               "name": "sqs-source",
               "confluent.topic.bootstrap.servers": "broker:9092",
               "confluent.topic.replication.factor": "1"
          }
EOF
```

Verify we have received the data in test-sqs-source topic:

```bash
playground topic consume --topic test-sqs-source --min-expected-messages 2 --timeout 60

{
  "ApproximateFirstReceiveTimestamp": 1569859344138,
  "ApproximateReceiveCount": 1,
  "SenderId": "AIDA6PUJEN7W4EMZQTVNV",
  "SentTimestamp": 1569858932274,
  "MessageDeduplicationId": null,
  "MessageGroupId": null,
  "SequenceNumber": null,
  "Body": "Fuel report for account 0001 on 2015-09-16 at 02:07:31 PM."
}
{
  "ApproximateFirstReceiveTimestamp": 1569859344140,
  "ApproximateReceiveCount": 1,
  "SenderId": "AIDA6PUJEN7W4EMZQTVNV",
  "SentTimestamp": 1569858932290,
  "MessageDeduplicationId": null,
  "MessageGroupId": null,
  "SequenceNumber": null,
  "Body": "Fuel report for account 0002 on 2015-09-16 at 02:09:30 PM."
}
```

### With SSL authentication:

Create a FIFO queue `sqs-source-connector-demo-sql`:

```bash
$ aws sqs create-queue --queue-name sqs-source-connector-demo-ssl
```

Send messages to queue (QUEUE_URL is generated by the script)

```bash
$ aws sqs send-message-batch --queue-url $QUEUE_URL --entries file://send-message-batch.json
```


The connector is created with:

```bash
playground connector create-or-update --connector sqs-source-ssl --environment "${PLAYGROUND_ENVIRONMENT}" << EOF
{
                    "connector.class": "io.confluent.connect.sqs.source.SqsSourceConnector",
                    "tasks.max": "1",
                    "kafka.topic": "test-sqs-source-ssl",
                    "sqs.url": "$QUEUE_URL",
                    "confluent.license": "",
                    "confluent.topic.bootstrap.servers": "broker:9092",
                    "confluent.topic.replication.factor": "1",
                    "confluent.topic.ssl.keystore.location" : "/etc/kafka/secrets/kafka.connect.keystore.jks",
                    "confluent.topic.ssl.keystore.password" : "confluent",
                    "confluent.topic.ssl.key.password" : "confluent",
                    "confluent.topic.ssl.truststore.location" : "/etc/kafka/secrets/kafka.connect.truststore.jks",
                    "confluent.topic.ssl.truststore.password" : "confluent",
                    "confluent.topic.ssl.keystore.type" : "JKS",
                    "confluent.topic.ssl.truststore.type" : "JKS",
                    "confluent.topic.security.protocol" : "SSL"
          }
EOF
```

Verify we have received the data in test-sqs-source topic:

```bash
playground topic consume --topic test-sqs-source-ssl --min-expected-messages 2 --timeout 60
```

### With SASL_SSL authentication:

Create a FIFO queue `sqs-source-connector-demo-sasl-sql`:

```bash
$ aws sqs create-queue --queue-name sqs-source-connector-demo-sasl-ssl
```

Send messages to queue (QUEUE_URL is generated by the script)

```bash
$ aws sqs send-message-batch --queue-url $QUEUE_URL --entries file://send-message-batch.json
```


The connector is created with:

```bash
playground connector create-or-update --connector sqs-source-sasl-ssl --environment "${PLAYGROUND_ENVIRONMENT}" << EOF
{
                    "connector.class": "io.confluent.connect.sqs.source.SqsSourceConnector",
                    "tasks.max": "1",
                    "kafka.topic": "test-sqs-source-sasl-ssl",
                    "sqs.url": "$QUEUE_URL",
                    "confluent.license": "",
                    "confluent.topic.bootstrap.servers": "broker:9092",
                    "confluent.topic.replication.factor": "1",
                    "confluent.topic.ssl.keystore.location" : "/etc/kafka/secrets/kafka.connect.keystore.jks",
                    "confluent.topic.ssl.keystore.password" : "confluent",
                    "confluent.topic.ssl.key.password" : "confluent",
                    "confluent.topic.ssl.truststore.location" : "/etc/kafka/secrets/kafka.connect.truststore.jks",
                    "confluent.topic.ssl.truststore.password" : "confluent",
                    "confluent.topic.security.protocol" : "SASL_SSL",
                    "confluent.topic.sasl.mechanism": "PLAIN",
                    "confluent.topic.sasl.jaas.config": "org.apache.kafka.common.security.plain.PlainLoginModule required  username=\"client\" password=\"client-secret\";"
          }
EOF
```

Verify we have received the data in test-sqs-source topic:

```bash
playground topic consume --topic test-sqs-source-sasl-ssl --min-expected-messages 2 --timeout 60
```

N.B: Control Center is reachable at [http://127.0.0.1:9021](http://127.0.0.1:9021])
